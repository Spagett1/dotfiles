#!/usr/bin/bash
cd $(pwd)
if [ $1 = unsort ]; then
  mv ./*/*/{*.flac,*.mp3,*.opus} ./
  rmdir */* > /dev/null 2>&1
  rmdir * > /dev/null 2>&1
else if [ $1 = opus ]; then
  mkdir out 
  N=20
  for file in ./*
  do
      (
      # opus="out/$(echo ${file%.*}).opus"
      # echo $file $opus
      opusenc --bitrate 256 "$file" "out/${file%.*}.opus"
      ) &
      if [[ $(jobs -r -p | wc -l) -ge $N ]]; then
          # now there are $N jobs already running, so wait here for any job
          # to be finished so there is a place to start next one.
          wait -n
      fi
  done
  wait
  mv *.mp3 ./out
  rename 's/[*“”‘’\n<|>"[\]]//g; s/:/-/g; s/\s+/ /g; s/^\s*//; s/\s+\././g; '"s/'//g" out/*
else if [ $1 = sort ]; then
  for file in {*.flac,*.mp3,*.opus}; do
    if echo "$file" | grep "opus" >/dev/null;
    then
      artist=$(opusinfo "$file" | grep "ARTIST=" | grep -v "ALBUM" | grep -v "DISPLAY" | tr -d '\n' | cut -d= -f2)
      album=$(opusinfo "$file" | grep "ALBUM=" | tr -d '\n' | cut -d= -f2)
      [ ! -d "$artist/$album" ] && mkdir -p "$artist/$album"
      mv "$file" "$artist/$album/"
    else
      artist=`ffprobe -loglevel error -show_entries format_tags=artist -of default=noprint_wrappers=1:nokey=1 "$file"`
      artist="${artist// /_}"
      album=`ffprobe -loglevel error -show_entries format_tags=album -of default=noprint_wrappers=1:nokey=1 "$file"`
      album="${album// /_}"
      [ ! -d "$artist/$album" ] && mkdir -p "$artist/$album"
      mv "$file" "$artist/$album/"
    fi
  done
    rename "_" " " *
    rename "_" " " */*
    rename "_" " " */*/*
    rename "_" " " *
    rename "_" " " */*
    rename "_" " " */*/*
    rename "_" " " *
    rename "_" " " */*
    rename "_" " " */*/*
    rename "_" " " *
    rename "_" " " */*
    rename "_" " " */*/*
    rename "_" " " *
    rename "_" " " */*
    rename "_" " " */*/*
    rename "_" " " *
    rename "_" " " */*
    rename "_" " " */*/*
    rename "_" " " *
    rename "_" " " */*
    rename "_" " " */*/*
fi
fi
fi
fi
mpc up
